<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tennis Breakdown – Équipe en temps réel</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #141414;
      --text: #e5e5e5;
      --accent: #ff5722; /* Orange vif */
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --muted: #6b6b6b;
    }
    body { background: var(--bg); color: var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; margin: 0; padding: 2rem; }
    h1 { color: var(--accent); margin-bottom: .5rem; font-size: 1.75rem; }
    .subtitle { color: var(--muted); margin-bottom: 2rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    .card { background: var(--card); border: 1px solid #222; border-radius: 10px; padding: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,.35); }
    .card h2 { margin: 0 0 .5rem; font-size: 1.1rem; color: var(--accent); }
    .row { display: flex; justify-content: space-between; align-items: center; margin: .35rem 0; font-size: .95rem; }
    .val { font-weight: 600; }
    .status { padding: .15rem .55rem; border-radius: 999px; font-size: .75rem; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; }
    .status.running { background: rgba(34,197,94,.18); color: var(--ok); border: 1px solid var(--ok); }
    .status.idle { background: rgba(107,107,107,.15); color: var(--muted); border: 1px solid var(--muted); }
    .last { color: var(--muted); font-size: .85rem; margin-top: .5rem; }
    .progress-track { background: rgba(255,255,255,.08); border-radius: 6px; height: 8px; margin-top: .75rem; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width .5s ease; }
    .footer { margin-top: 2rem; color: var(--muted); font-size: .85rem; text-align: center; }
    .refresh { margin-top: 1rem; text-align: right; }
    .refresh button { background: var(--accent); border: none; color: white; padding: .5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .refresh button:hover { opacity: .9; }
  </style>
</head>
<body>
  <header>
    <h1>Tennis Breakdown – Équipe en direct</h1>
    <div class="subtitle">Dashboard des agents : charge et état</div>
  </header>

  <div class="grid" id="agents">
    <!--注入卡片 JS -->
  </div>

  <div class="refresh">
    <button onclick="reload()">Rafraîchir</button>
  </div>

  <div class="footer">
    Source : <code>tennis-breakdown/agents/progress.json</code> • Mis à jour automatiquement chaque 3 min
  </div>

  <script>
    const API = '/api/progress';
    function escapeHtml(str) {
      return String(str).replace(/[&<>'"]/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
      })[m]);
    }
    function formatDate(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      return d.toLocaleString('fr-FR', { timeZone: 'Africa/Tunis', hour12: false });
    }
    function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
    function render(progress) {
      const container = document.getElementById('agents');
      container.innerHTML = '';
      progress.sessions.forEach(s => {
        const card = document.createElement('div');
        card.className = 'card';
        const statusClass = s.status === 'running' ? 'running' : 'idle';
        const last = s.lastUpdate ? formatDate(s.lastUpdate) : '-';
        const task = s.task ? escapeHtml(s.task) : '-';
        const est = s.estimatedMinutes ? escapeHtml(s.estimatedMinutes + ' min') : '-';
        // Compute progress bar
        let progressPct = 0;
        if (s.status === 'running' && s.estimatedMinutes) {
          const start = new Date(progress.spawnedAt).getTime();
          const now = Date.now();
          const elapsedMs = now - start;
          const elapsedMin = elapsedMs / 60000;
          progressPct = Math.min(100, Math.round((elapsedMin / s.estimatedMinutes) * 100));
        } else if (s.status !== 'running') {
          progressPct = 100;
        }
        card.innerHTML = `
          <h2>${escapeHtml(s.role)}</h2>
          <div class="row"><span>État</span><span class="status ${statusClass}">${capitalize(s.status)}</span></div>
          <div class="row"><span>Objectif</span><span class="val" style="max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${task}">${task}</span></div>
          <div class="row"><span>Durée estimée</span><span class="val">${est}</span></div>
          <div class="progress-track"><div class="progress-fill" style="width:${progressPct}%"></div></div>
          <div class="row" style="margin-top:.5rem"><span>Dernière activité</span><span class="val">${last}</span></div>
          <div class="last">runId: ${escapeHtml(s.runId)}</div>
        `;
        container.appendChild(card);
      });
    }
    async function reload() {
      try {
        const res = await fetch(API, { cache: 'no-store' });
        const json = await res.json();
        render(json);
      } catch (e) {
        console.error(e);
      }
    }
    setInterval(reload, 180000); // 3 min
    reload();
  </script>
</body>
</html>